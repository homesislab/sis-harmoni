name: CI

on:
  push:
    branches: ["master", "main"]
  pull_request:
    branches: ["master", "main"]

jobs:
  build-and-test:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v3

      - name: Build Docker images
        run: docker compose build

      - name: Start services
        run: docker compose up -d

      - name: Wait for database
        run: |
          echo "Waiting for database..."
          sleep 10

      - name: Run PHP Lint
        run: docker compose run --rm app find application -name "*.php" -print0 | xargs -0 -n1 php -l

      - name: Stop services
        run: docker compose down

  deploy:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
      - name: Install Cloudflared
        run: |
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared.deb

      - name: Deploy to Server (Native SSH)
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_KEY }}
          SSH_USER: ${{ secrets.SSH_USER }}
          CF_ID: ${{ secrets.CF_CLIENT_ID }}
          CF_SECRET: ${{ secrets.CF_CLIENT_SECRET }}
        run: |
          # 1. Prepare .ssh and private key
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # 2. Configure SSH to use Cloudflared
          echo "Host ssh.homesislab.my.id" >> ~/.ssh/config
          echo "  StrictHostKeyChecking no" >> ~/.ssh/config
          echo "  User $SSH_USER" >> ~/.ssh/config
          echo "  ProxyCommand cloudflared access ssh --hostname %h --id $CF_ID --secret $CF_SECRET" >> ~/.ssh/config

          # 3. Execute Deployment Script
          ssh ssh.homesislab.my.id << 'EOF'
            # Adjusted path to current project: sis-harmoni
            cd /home/gie/workspace/sis-harmoni
            git fetch origin main
            git reset --hard origin/main
            docker compose up -d --build
            docker image prune -f
          EOF
